name: Build NextJS website
description: Build NextJS website

inputs:
  environment:
    description: 'The target environment'
    default: 'dev'
    required: false
  path_to_gitbook_docs:
    description: 'The absolute path to GitBook content'
    required: true
  cookie_domain_script:
    description: 'The data-domain-script code needed by cookie script from One Trust'
    required: false
  allow_crawler:
    description: 'Allow crawler to index the website, by default are not allowed'
    required: false
  cognito_user_pool_id:
    description: 'The id of the User Pool on Cognito, needed for the authentication'
    required: true
  cognito_app_client_id:
    description: 'The App Client registered on Cognito'
    required: true
  cognito_aws_region:
    description: 'The region where Cognito has been deployed. Default set to Milan region'
    required: false
    default: 'eu-south-1'
  snackbar_auto_hide_duration_ms:
    description: 'The duration in milliseconds of the snackbar'
    required: false
    default: '10000'
  reset_resend_email_after_ms:
    description: 'The time in milliseconds the user must wait before resending the email'
    required: false
    default: '4000'

runs:
  using: "composite"
  steps:
    - name: Fetch docs from GitBook
      shell: bash
      run: npm run download-docs -w nextjs-website

    - name: Restore NextJS cache
      uses: actions/cache@88522ab9f39a2ea568f7027eddc7d8d8bc9d59c8 # v3.3.1
      with:
        path: ${{ github.workspace }}/apps/nextjs-website/.next/cache
        # Generate a new cache whenever packages or source files change.
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.[jt]s', '**/*.[jt]sx') }}
        # If source files changed but packages didn't, rebuild from a prior cache.
        restore-keys: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

    - name: Build static website
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        NEXT_PUBLIC_ENVIRONMENT: ${{ inputs.environment }}
        PATH_TO_GITBOOK_DOCS: ${{ inputs.path_to_gitbook_docs }}
        COOKIE_DOMAIN_SCRIPT: ${{ inputs.cookie_domain_script }}
        ALLOW_CRAWLER: ${{ inputs.allow_crawler }}
        NEXT_TELEMETRY_DISABLED: '1'
        NEXT_PUBLIC_COGNITO_USER_POOL_WEB_CLIENT_ID: ${{ inputs.cognito_app_client_id }}
        NEXT_PUBLIC_COGNITO_REGION: ${{ inputs.cognito_aws_region }}
        NEXT_PUBLIC_COGNITO_USER_POOL_ID: ${{ inputs.cognito_user_pool_id }}
        SNACKBAR_AUTO_HIDE_DURATION_MS: ${{ inputs.snackbar_auto_hide_duration_ms }}
        RESET_RESEND_EMAIL_AFTER_MS: ${{ inputs.reset_resend_email_after_ms }}
      shell: bash
      run: npm run build -w nextjs-website
