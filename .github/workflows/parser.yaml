name: Run Parser

on:
  workflow_dispatch:
    inputs:
      urls:
        description: 'URLs to parse (comma-separated)'
        required: true
        type: string
      environment:
        description: 'The environment used as target'
        type: choice
        required: true
        default: dev
        options:
          - dev
          - uat
          - prod
      parser_vector_index_name:
        description: 'Parser Vector Index Name (optional, overrides secret)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  run-parser:
    name: Run Parser Script (manual on ${{ inputs.environment }})
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        working-directory: apps/parser
        run: npm ci
      
      - name: Run Parser for each URL
        env:
          PARSER_VECTOR_INDEX_NAME: ${{ inputs.parser_vector_index_name || secrets.PARSER_VECTOR_INDEX_NAME }}
        working-directory: apps/parser
        run: |
          # Split comma-separated URLs and loop sequentially
          IFS=',' read -ra url_array <<< "${{ inputs.urls }}"
          for url in "${url_array[@]}"; do
            url="$(echo "$url" | xargs)"  # trim whitespace
            if [ -n "$url" ]; then
              # Basic validation: require http/https and disallow dangerous shell metacharacters
              if ! [[ "$url" =~ ^https?:// ]]; then
                echo "Skipping invalid URL (must start with http:// or https://): $url"
                continue
              fi
              if [[ "$url" =~ [\'\"\\\`\$\&\;\|\>\<\(\)\{\}] ]]; then
                echo "Skipping URL containing disallowed characters: $url"
                continue
              fi
              echo "=== Parsing: $url ==="
              PARSER_VECTOR_INDEX_NAME="${PARSER_VECTOR_INDEX_NAME}" URL="$url" npx tsx src/main.ts
              echo "=== Completed: $url ==="
              echo ""
            fi
          done
